<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Teacher Dashboard</title>
    <link rel="stylesheet" href="./style/style.css" />
    <link href="./style/output.css" rel="stylesheet" />
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
      import {
        getDatabase,
        ref,
        onValue,
      } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";
      import {
        getAuth,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
      import {
        getStorage,
        ref as storageRef,
        listAll,
        getDownloadURL,
      } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-storage.js";

      const firebaseConfig = {
        // Your Firebase configuration
      };

      const app = initializeApp(firebaseConfig);
      const database = getDatabase(app);
      const auth = getAuth(app);
      const storage = getStorage(app);

      onAuthStateChanged(auth, (user) => {
        if (user) {
          const teacherId = user.uid;
          console.log("Teacher logged in:", teacherId);
          displayTeacherDashboard(teacherId);
        } else {
          console.log("Teacher not logged in");
          window.location.href = "teacher_login.html";
        }
      });

      function displayTeacherDashboard(teacherId) {
        const teacherRef = ref(database, `teachers/${teacherId}`);
        onValue(teacherRef, (snapshot) => {
          const teacherData = snapshot.val();
          if (teacherData && teacherData.classes_sections) {
            const classes = teacherData.classes_sections.classes;
            renderClassDropdown(classes);
          } else {
            console.error("Teacher classes data not found");
          }
        });
      }

      function renderClassDropdown(classes) {
        const classDropdown = document.getElementById("classDropdown");
        classDropdown.innerHTML = "";

        const option = document.createElement("option");
        option.value = "";
        option.textContent = "Select a class";
        classDropdown.appendChild(option);

        classes.forEach((classItem) => {
          const option = document.createElement("option");
          option.value = classItem;
          option.textContent = classItem;
          classDropdown.appendChild(option);
        });

        classDropdown.addEventListener("change", () => {
          const selectedClass = classDropdown.value;
          fetchStudentNames(selectedClass);
        });
      }

      function fetchStudentNames(selectedClass) {
        const usersRef = ref(database, "users");
        onValue(usersRef, (snapshot) => {
          const usersData = snapshot.val();
          const studentNames = {};
          for (const userId in usersData) {
            const user = usersData[userId];
            if (user.class === selectedClass) {
              studentNames[userId] = user.username;
            }
          }
          renderStudentNames(studentNames);
        });
      }

      function renderStudentNames(studentNames) {
        const studentNamesContainer = document.getElementById(
          "studentNamesContainer"
        );
        studentNamesContainer.innerHTML = "";
        for (const userId in studentNames) {
          const studentName = studentNames[userId];
          const studentLink = document.createElement("a");
          studentLink.href = "#";
          studentLink.textContent = studentName;
          studentLink.addEventListener("click", () =>
            fetchStudentSubjects(userId)
          );
          const listItem = document.createElement("li");
          listItem.appendChild(studentLink);
          studentNamesContainer.appendChild(listItem);
        }
      }

      function fetchStudentSubjects(userId) {
        const userRef = ref(database, `users/${userId}/homework`);
        onValue(userRef, (snapshot) => {
          const userHomework = snapshot.val();
          if (userHomework) {
            const subjects = Object.keys(userHomework);
            renderSubjectLinks(subjects, userId);
          } else {
            console.error("Student homework data not found");
          }
        });
      }

      function renderSubjectLinks(subjects, userId) {
        const subjectLinksContainer = document.getElementById(
          "subjectLinksContainer"
        );
        subjectLinksContainer.innerHTML = "";
        for (const subject of subjects) {
          const subjectLink = document.createElement("a");
          subjectLink.href = "#";
          subjectLink.textContent = subject;
          subjectLink.addEventListener("click", () =>
            fetchStudentImages(userId, subject)
          );
          const listItem = document.createElement("li");
          listItem.appendChild(subjectLink);
          subjectLinksContainer.appendChild(listItem);
        }
      }

      function fetchStudentImages(userId, subject) {
        const storageRef = getStorage();
        const listRef = ref(storageRef, `homework_img/${userId}/${subject}`);

        listAll(listRef)
          .then((res) => {
            const imageLinks = [];
            res.items.forEach((itemRef) => {
              getDownloadURL(itemRef).then((url) => {
                imageLinks.push(url);
              });
            });
            renderImageContainers(imageLinks);
          })
          .catch((error) => {
            console.error("Error fetching student images:", error);
          });
      }

      function renderImageContainers(imageLinks) {
        const imageContainersContainer = document.getElementById(
          "imageContainersContainer"
        );
        imageContainersContainer.innerHTML = "";
        for (const imageLink of imageLinks) {
          const imageContainer = document.createElement("div");
          const image = document.createElement("img");
          image.src = imageLink;
          image.alt = "Student Image";
          imageContainer.appendChild(image);
          imageContainersContainer.appendChild(imageContainer);
        }
      }
    </script>
  </head>
  <body class="bg-gray-100">
    <div class="container mx-auto mt-8 p-4">
      <div class="bg-white rounded-lg shadow-md p-4">
        <h2 class="text-lg font-semibold mb-4">Class</h2>
        <select id="classDropdown"></select>
      </div>

      <div class="bg-white rounded-lg shadow-md p-4 mt-4">
        <h2 class="text-lg font-semibold mb-4">Student Names</h2>
        <ul id="studentNamesContainer"></ul>
      </div>

      <div class="bg-white rounded-lg shadow-md p-4 mt-4">
        <h2 class="text-lg font-semibold mb-4">Student Subjects</h2>
        <ul id="subjectLinksContainer"></ul>
      </div>

      <div class="bg-white rounded-lg shadow-md p-4 mt-4">
        <h2 class="text-lg font-semibold mb-4">Student Images</h2>
        <div id="imageContainersContainer" class="flex flex-wrap"></div>
      </div>
    </div>
  </body>
</html>